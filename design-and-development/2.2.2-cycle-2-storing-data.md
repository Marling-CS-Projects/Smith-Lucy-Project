# 2.2.2 Cycle 2: Storing Data

## Design

In the previous cycle, I produced a program that was able to collect data from sensors and upload these values to the particle cloud. In this section, I will now focus on how this data can be processed and stored, to make it accessible to my weather application.

In this cycle I aim to learn how to use a text-based database (MongoDB). I will then produce a program that uploads readings from the weather station to the database so that it can be accessed in later cycles.

### Objectives

* [x] Learn how to use MongoDB
* [x] Design a program that uploads data to MongoDB
* [ ] Use database to record data from the weather station
* [ ] Data processing

### Usability Features

Ensuring that this database works correctly is vital to my project because it will allow my app to connect to the weather station and show trends in the environment over time. The program should automatically upload and store data without any input from the user. To improve usability for the stakeholder, the data recorded on MongoDB must be accurate and valid, to prevent any incorrect data trends or problems in later development cycles.

### Tests I need to conduct

| ID  | Test                                       | Description                                                                                                                                       | Pass Criteria                                                                                                                                                      |
| --- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 2.1 | Design basic program to setup the database | In this test, I will learn how to interact with mongoDB                                                                                           | As well as connecting to the database, I will test a program that is able to perform several tasks, including inserting, updating, deleting and finding documents. |
| 2.2 | Set up a remote MQTT broker                | In this section, I will connect the particle argon to a broker (such as HiveMQ).                                                                  |                                                                                                                                                                    |
| 2.3 | Setup database with weather station        | In this section, I will use the data from my weather station program and publish it to the broker, so that it can then be recorded on my database |                                                                                                                                                                    |
| 2.4 | Data processing and validation             | I will adapt the program to ensure that data from the weather station is recorded at regular intervals, and only valid/accurate data is stored    |                                                                                                                                                                    |

### Data Structures

| Structure name | Structure type | Description |
| -------------- | -------------- | ----------- |
|                |                |             |
|                |                |             |
|                |                |             |

### Development

### 2.1

In the first part of this cycle, I am going to learn how to use MongoDB (a document-based database), including adding a post, making changes and retrieving data. I have decided to use phython to interact with MongoDB.

#### Inserting documents into the database

I started by writing a basic program that can interact with my database.

```python
import pymongo
from pymongo import MongoClient

client= MongoClient("mongodb+srv://lrosesmith23:<password>@mystation.uoil79h.mongodb.net/?retryWrites=true&w=majority") #selects client

db = client.weatherStationData #Selects database

collection = db.weather #Select collection in database

#Insert a post into a database
post = {"_id": 1, "date": "21/06/23", "temperature": 27, "airquality": "fresh air"} #Sample data

collection.insert_one(post)
```

Using pymongo, I was successfully able to interact with my database and inset a post. The results of this program can be seen below.

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 11.21.38.png" alt=""><figcaption></figcaption></figure>

If I don't assign an ID to the document, one is automatically generated when the post is inserted.&#x20;

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 11.33.52.png" alt=""><figcaption></figcaption></figure>

After inserting one document into my database, I then decided to adapt my database to insert multiple posts at once.

```python
#4 document examples
post1 = {"_id": 2, "date": "21/06/23", "temperature": 19, "airquality": "fresh air"} 
post2 = {"_id": 3, "date": "21/06/23", "temperature": 21, "airquality": "low polution"}
post3 = {"_id": 4, "date": "21/06/23", "temperature": 27, "airquality": "hight polution"}
post4 = {"_id": 5, "date": "21/06/23", "temperature": 22, "airquality": "danger"}

#Insert many documents into the collection
collection.insert_many([post1, post2, post3, post4])
```

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 11.47.16.png" alt=""><figcaption></figcaption></figure>

#### Updating documents

Within my solution, I may need to make changes to the data stored in my weather station. I used the .update\_one() and .update\_many() methods to setup new fields.

```python
#UPDATE DOCUMENT

#Adding a new field to one document
collection.update_one({"_id":1}, {"$set": {"humidity": 45}})

#Adding a new field to multiple documents
collection.update_many({"temperature": 27}, {"$set": {"pressure": 10000}})

#Updating an old field
collection.update_one({"_id": 5}, {"$set": {"airquality": "fresh air"}})
```

The changes made to my database after running this program can be seen below.

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 13.29.36.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 13.30.59.png" alt=""><figcaption></figcaption></figure>

This program made the expected alterations to my database and therefore passed the test.

#### Deleting documents

Throughout my project, I will need to be able to delete old documents or remove incorrect and inaccurate data. This can be done using the .delete\_one() or .delete\_many() method.

<pre class="language-python"><code class="lang-python"># Delete one item 
<strong>collection.delete_one({"_id":1})
</strong>
# Delete multiple posts
collection.delete_many({"temperature":27})

# Deletes all documents in the database
collection.delete_many({})
</code></pre>

I tested each of these lines of code individually. The first test successfully removed the document with and ID of 1 from my database. After running the second test, all lines of code that has a temperature of 27 where removed. After running the final test, all posts in the database where removed, leaving me with an empty database.

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 13.04.12.png" alt=""><figcaption></figcaption></figure>

#### Finding documents

When retrieving data from my database, I will need to use a query to search for specific attributes in documents. For instance, I may need to search for dates, times and weather events. After adding back the origonal posts to the database, I used the code below to search for documents in my database.



```python
#FINDING DOCUMENTS

# Test 1 - Searching for a post by its ID
findings1 = collection.find_one({"_id": 1})
print("Test 1: " + str(findings1))

# Test 2 - Looking for multiple posts with the same attributes
findings2 = collection.find({"temperature": 27})
print("\nTest 2:")

for doc in findings2:
    print(doc)

# Test 3 - Search by multiple fields
findings3 = collection.find({"_id": 1, "temperature": 27})
print("\nTest 3: ")

for doc in findings3:
    print(doc)

# Test 4 - No criteria
findings4 = collection.find({})
print("\nTest 4:")

for doc in findings4:
    print(doc)
```

Outputs from the terminal:

<figure><img src="../.gitbook/assets/Screenshot 2023-06-21 at 12.22.14.png" alt=""><figcaption></figcaption></figure>

In the first test, I used the .find\_one() method to search for a particular ID, which printed out one document as expected. The second test searched for multiple posts with the same value (27) for temperature. As expected, this returned 3 documents, so the test passed. Next, I tried searching using multiple attributes, ID and temperature. Finally, in test 4 I used the .find() method without any conditions, which returned all the documents in my database.

### 2.2

In tests [2.2](2.2.2-cycle-2-storing-data.md#2.2) and [2.3](2.2.2-cycle-2-storing-data.md#2.3), I am going to design a program that uploads weather documents to this database, simulating the readings from my weather station. In [Cycle 1: Data Collection](cycle-1.md), I collected data on temperature, humidity, pressure, altitude, air quality, air pressure, dust concentration, light and sound from sensors. These fields will therefore have to be included in the documents. Addititionally, so that I can monitor weather conditions in my solution, I need to record the data and time these readings were taken. Readings must be inserted into the database at regular intervals, and I must also consider the capacity of my database when keeping data over long periods of time.

### Pseudocode

```python
// Some code
```

However, before I can upload data to the database, the data on the particle Argon needs to be accessed by the python program. To do this, used the MQTT protocol to connect to a broker (e.g. HiveMQ) and then saved the data to MongoDB. The diagram below summarises how this will work.

<figure><img src="../.gitbook/assets/Screenshot 2023-06-22 at 20.03.10.png" alt=""><figcaption></figcaption></figure>

#### Setting up a remote MQTT broker

Before I designed a program to publish data on the particle Argon, I first needed to test the connection with the broker in the terminal.

```
mosquitto_sub -h 683186625ce24d4aa43825f47a959ede.s2.eu.hivemq.cloud -p 8883 -u lucyargon22 -P <mypassword> -t lucystopoc
```

In a different terminal, I then published a test message to the MQTT broker by running the following commands.

```
mosquitto_pub -h 683186625ce24d4aa43825f47a959ede.s2.eu.hivemq.cloud -p 8883 -u lucyargon22 -P myproject22! -t lucystopoc -m "Hello World"
mosquitto_pub -h 683186625ce24d4aa43825f47a959ede.s2.eu.hivemq.cloud -p 8883 -u lucyargon22 -P myproject22! -t lucystopoc -m "Testing, testing..."
```

<figure><img src="../.gitbook/assets/Screenshot 2023-06-22 at 19.31.08.png" alt=""><figcaption></figcaption></figure>

As expected, I then recieved both messages in the first terminal, confirming that the MQTT broker was working correctly.

#### Connecting to broker via the Argon

#### Publishing weather data to the MQTT broker

### 2.3

### 2.4

## Outcome

### Testing

| Test | Instructions | What I expected | What actually happens | Pass/Fail |
| ---- | ------------ | --------------- | --------------------- | --------- |
| 1    |              |                 |                       |           |
| 2    |              |                 |                       |           |
| 3    |              |                 |                       |           |

### Challenges

### Evidence
